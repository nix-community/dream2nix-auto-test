<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Main</title>
	<link rel="stylesheet" href="https://the.missing.style">
	<script type="text/hyperscript" src="behaviors.hs"></script>
	<script src="https://unpkg.com/nunjucks@latest"></script>
	<script src="https://unpkg.com/htmx.org@1.8.0"
		integrity="sha384-cZuAZ+ZbwkNRnrKi05G/fjBX+azI9DNOkNYysZ0I/X5ZFgsmMiBXgDZof30F5ofc"
		crossorigin="anonymous"></script>
	<script src="https://unpkg.com/htmx.org@1.8.0/dist/ext/client-side-templates.js"></script>
	<script src="https://unpkg.com/hyperscript.org@0.9.5/dist/_hyperscript_w9y.min.js"></script>
	<style>
		details[data-status].jobs {}

		details[data-status="BuildFailure"].jobs {
			display: block !important;
		}

		li[data-status="Failure"] {
			color: red;
		}

		pre {
			height: 10em;
			overflow: scroll;
		}

		:root {
			--line-length: 80vw;
		}
	</style>
	<my-templates></my-templates>

	<script>
		// template loader
		class MyTemplates extends HTMLElement {
			async connectedCallback() {
				let elt = this;
				for (const t of ["branches", "translation-errors", "builds", "jobs"]) {
					let res = await fetch(`./templates/${t}.html`);
					let d = document.createElement("div");
					d.innerHTML = await res.text();
					elt.appendChild(d);
				}
				htmx.trigger("#main-section", "loaded");
			}
		}
		customElements.define('my-templates', MyTemplates)

		htmx.defineExtension("filter-hercules-jobs", {
			transformResponse: function(text, xhr, elt) {
				data = {}
				data.list = JSON.parse(text);
				data.name = elt.dataset['name'];
				return JSON.stringify(data);
			},
		});
		htmx.defineExtension("filter-hercules-evaluation", {
			transformResponse: function(text, xhr, elt) {
				var data = JSON.parse(text);
				let success = [];
				let buildFailure = [];
				let dependencyFailure = [];
				data.attributes.forEach(function(item) {
					if (item.value.Ok === undefined) {
						buildFailure.push(item)
						return
					}
					if (item.value.Ok.status === "BuildFailure") {
						buildFailure.push(item);
						return
					}
					if (item.value.Ok.status ===
						"DependencyFailure") {
						dependencyFailure.push(item);
						return
					}
					success.push(item)
				});
				let failures = buildFailure.concat(dependencyFailure)
				data.checks = failures.filter(function(item) {
					return item.path[0] === "checks";
				});
				data.checksCountSuccess = success.filter(function(item) {
					return item.path[0] === "checks";
				}).length;
				data.checksCountFailure = data.checks.length;

				data.attributes = [];
				data.jobid = htmx.find("#jobid").dataset.jobid;

				data.checks.forEach((item, index) => {
					if (item.value && item.value.Ok && item.value
						.Ok.derivationPath) {
						data.checks[index].value.Ok
							.derivationPath = encodeURIComponent(
								item.value.Ok.derivationPath
							);
					}
				});
				data.name = elt.dataset['name'];

				return JSON.stringify(data);
			},
		});
	</script>
</head>

<body>

	<main hx-ext="client-side-templates">
		<h2>dream2nix status</h2>
		<section id="main-section" hx-get="indexes.json" hx-trigger="loaded once"
			hx-swap="innerHTML" nunjucks-template="branches"
			hx-ext="filter-hercules-jobs"
			>....loading
		</section>
	</main>
</body>

</html>
<!-- vim: set nu sw=2 ts=2 noet : -->
